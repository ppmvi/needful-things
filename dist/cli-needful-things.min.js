/*!
 * Needful things v1.5.0
 * Copyright 2019 Florian Weber - ppm visuals & internet GmbH
 * Released under the MIT License.
*/
import e from"@babel/runtime/regenerator";import r from"@babel/runtime/helpers/asyncToGenerator";import t from"rfg-api";import n from"pify";import o from"@babel/runtime/helpers/objectSpread";import s from"fs";import a from"path";import i from"ora";import c from"@babel/runtime/helpers/classCallCheck";import u from"@babel/runtime/helpers/createClass";import p from"@babel/runtime/helpers/possibleConstructorReturn";import l from"@babel/runtime/helpers/getPrototypeOf";import m from"@babel/runtime/helpers/inherits";import f from"tinify";import d from"inquirer";import h from"glob";import g from"log-symbols";import _ from"chalk";import v from"@babel/runtime/helpers/defineProperty";import b from"png-metadata";import{load as y,TagValues as k,dump as F,insert as x}from"piexifjs";var w,C=a.resolve(process.cwd(),"./.ppmvi.js");s.existsSync(C)&&(w=require(C).default.favicons||{});if(w&&w.master_picture&&"inline"===w.master_picture.type){var E=a.resolve(process.cwd(),w.master_picture.content);s.existsSync(E)&&(w.master_picture.content=s.readFileSync(E).toString("base64"))}const S=o({},{api_key:"",master_picture:{type:"url",url:""},files_location:{type:"path",path:"/static/icons"},favicon_design:{desktop_browser:{},ios:{picture_aspect:"background_and_margin",margin:"8",background_color:"#FFFFFF",assets:{ios6_and_prior_icons:!1,ios7_and_later_icons:!1,precomposed_icons:!1,declare_only_default_icon:!0}},windows:{picture_aspect:"white_silhouette",background_color:"#FFFFFF",assets:{windows_80_ie_10_tile:!0,windows_10_ie_11_edge_tiles:{small:!1,medium:!0,big:!1,rectangle:!1}}},android_chrome:{picture_aspect:"background_and_margin",margin:"12",background_color:"#FFFFFF",theme_color:"#FFFFFF",manifest:{name:"My sample app",display:"standalone",orientation:"portrait",start_url:"/"},assets:{legacy_icon:!1,low_resolution_icons:!1}},safari_pinned_tab:{picture_aspect:"black_and_white",threshold:60,theme_color:"#FFFFFF"}},settings:{compression:"5",scaling_algorithm:"Mitchell",error_on_image_too_small:!0,readme_file:!1,html_code_file:!1,use_path_as_is:!0}},w);function U(){return T.apply(this,arguments)}function T(){return(T=r(e.mark(function r(){var o,s,a,c=arguments;return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=c.length>0&&void 0!==c[0]?c[0]:"./static/icons",s=i("Generating Favicons").start(),a=t.init(),e.prev=3,e.next=6,n(a.generateFavicon)(S,o);case 6:s.succeed(),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),s.fail(e.t0.message);case 12:case"end":return e.stop()}},r,null,[[3,9]])}))).apply(this,arguments)}var M=function(){function e(){c(this,e)}return u(e,[{key:"readUserComment",value:function(e){var r="",t=a.extname(e),n=s.readFileSync(e).toString("binary");if(".png"===t){var o=b.splitChunk(n),i=this.getUserCommentFromPngChunks(o);r=i?i.data:""}else{var c=".png"!==t?y(n).Exif:void 0;r=void 0!==c&&c[k.ExifIFD.UserComment]?c[k.ExifIFD.UserComment]:""}return r}},{key:"addUserComment",value:function(r,t){var n=r;if(".png"===a.extname(t)){var o=b.splitChunk(r);if(!this.getUserCommentFromPngChunks(o)){var s=o.pop(),i=b.createChunk(e.PNG_TEXT_CHUNKG_FLAG,e.EXIF_USER_COMMENT);o.push(i),o.push(s),n=b.joinChunk(o)}}else{var c={Exif:v({},k.ExifIFD.UserComment,e.EXIF_USER_COMMENT)},u=F(c);n=x(u,r)}return Buffer.from(n,"binary")}},{key:"getUserCommentFromPngChunks",value:function(r){var t,n=!0,o=!1,s=void 0;try{for(var a,i=r[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var c=a.value;if(c.type===e.PNG_TEXT_CHUNKG_FLAG){t=c;break}}}catch(e){o=!0,s=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw s}}return t}}],[{key:"EXIF_USER_COMMENT",get:function(){return"Compressed with TinyPNG by @ppmvi/needful-things"}},{key:"PNG_TEXT_CHUNKG_FLAG",get:function(){return"tEXt"}}]),e}(),G=function(t){function v(){var e;return c(this,v),(e=p(this,l(v).call(this))).getConfig(),f.key=e.config.tinify.key,e}return m(v,M),u(v,[{key:"run",value:function(){var t=r(e.mark(function r(){var t,n,o,s,a,i;return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.setCompressionCount();case 3:return e.next=5,this.getFiles();case 5:if(t=e.sent,!(t.filter(function(e){return!(e.disabled||e instanceof d.Separator)}).length>0)){e.next=22;break}return e.next=10,d.prompt([{type:"checkbox",message:"Select the files which should be compressed.",name:"selectedFiles",pageSize:t.length,choices:t,validate:function(e){return!(e.length<1)||"You must at least choose one image."}}]);case 10:return n=e.sent,o=n.selectedFiles,e.next=14,d.prompt([{type:"confirm",message:"You are about to compress the selected images. Do you want to continue?",name:"compress",default:!0},{type:"confirm",message:"Do you want to add a compressed flag to the file name? eg. test_compressed.png",name:"addCompressFlag",default:!1,when:function(e){return e.compress}}]);case 14:if(s=e.sent,a=s.compress,i=s.addCompressFlag,!a){e.next=20;break}return e.next=20,this.doCompression(o,i);case 20:e.next=23;break;case 22:console.log(g.info,_.bold("You already compressed all images."));case 23:e.next=29;break;case 25:e.prev=25,e.t0=e.catch(0),console.log(e.t0),console.log(g.error,_.bold("Looks like your key is not valid."));case 29:case"end":return e.stop()}},r,this,[[0,25]])}));return function(){return t.apply(this,arguments)}}()},{key:"doCompression",value:function(){var t=r(e.mark(function r(){var t,n,o,c,u,p,l,m,d=this,h=arguments;return e.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:t=h.length>0&&void 0!==h[0]?h[0]:[],n=h.length>1&&void 0!==h[1]&&h[1],o=!0,c=!1,u=void 0,r.prev=5,p=e.mark(function r(){var t,o,c,u,p,l,h,g,_;return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=m.value,o=process.cwd()+t,c=a.dirname(o),u=a.extname(o),p=a.basename(o).replace(u,""),l=n?"_compressed":"",h=s.readFileSync(o),g=i("Compressing ".concat(p).concat(u)).start(),_=void 0,e.prev=9,e.next=12,new Promise(function(e,r){f.fromBuffer(h).toBuffer(function(t,n){t&&r(t),e(n)})});case 12:_=e.sent,e.next=19;break;case 15:return e.prev=15,e.t0=e.catch(9),g.fail(e.t0.message),e.abrupt("return","break");case 19:s.writeFileSync("".concat(c,"/").concat(p).concat(l).concat(u),d.addUserComment(_.toString("binary"),o)),g.succeed();case 21:case"end":return e.stop()}},r,null,[[9,15]])}),l=t[Symbol.iterator]();case 8:if(o=(m=l.next()).done){r.next=16;break}return r.delegateYield(p(),"t0",10);case 10:if("break"!==r.t0){r.next=13;break}return r.abrupt("break",16);case 13:o=!0,r.next=8;break;case 16:r.next=22;break;case 18:r.prev=18,r.t1=r.catch(5),c=!0,u=r.t1;case 22:r.prev=22,r.prev=23,o||null==l.return||l.return();case 25:if(r.prev=25,!c){r.next=28;break}throw u;case 28:return r.finish(25);case 29:return r.finish(22);case 30:case"end":return r.stop()}},r,null,[[5,18,22,30],[23,,25,29]])}));return function(){return t.apply(this,arguments)}}()},{key:"getFiles",value:function(){var t=r(e.mark(function r(){var t,o,s=this;return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n(h)(process.cwd()+"/src/**/*.{png,jpg,jpeg}",{});case 2:return t=e.sent,o="",e.abrupt("return",t.reduce(function(e,r,t){var n=r.replace(process.cwd(),"");return o?o&&o!==a.dirname(n)&&(e.push(new d.Separator("----------")),o=a.dirname(n)):o=a.dirname(n),e.push({name:n,checked:!0,disabled:!(!n.match(/compressed/)&&!s.readUserComment(r).includes(M.EXIF_USER_COMMENT))&&"Already compressed"}),e},[]));case 5:case"end":return e.stop()}},r)}));return function(){return t.apply(this,arguments)}}()},{key:"setCompressionCount",value:function(){var t=r(e.mark(function r(){return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,new Promise(function(e,r){f.validate(function(t){t&&r(t),e()})});case 3:this.compressionsThisMonth=f.compressionCount,void 0===this.compressionsThisMonth?console.log(g.info,_.bold("Couldnt get the compressions count. You probably havent done any compressions.")):console.log(g.info,_.bold("You already used ".concat(this.compressionsThisMonth,"/500 free compressions this month."))),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(0),e.t0;case 10:case"end":return e.stop()}},r,this,[[0,7]])}));return function(){return t.apply(this,arguments)}}()},{key:"getConfig",value:function(){var e=a.resolve(process.cwd(),"./.ppmvi.js"),r={};s.existsSync(e)&&(r=require(e).default),this.config=o({},{tinify:{key:""}},r)}}]),v}();function N(){return P.apply(this,arguments)}function P(){return(P=r(e.mark(function r(){var t;return e.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new G,e.next=3,t.run();case 3:case"end":return e.stop()}},r)}))).apply(this,arguments)}export{U as generateFavicons,N as tinify};
