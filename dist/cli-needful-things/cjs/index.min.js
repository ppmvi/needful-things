/*!
 * Needful things vnull
 * Copyright 2020 Florian Weber - ppm visuals & internet GmbH
 * Released under the MIT License.
*/
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("rfg-api")),r=e(require("pify")),n=e(require("fs")),o=e(require("path")),s=e(require("ora")),i=e(require("tinify")),a=e(require("glob")),c=e(require("log-symbols")),u=e(require("chalk")),l=e(require("png-metadata")),p=require("piexifjs"),f=require("inquirer"),d=function(e,t){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var m=function(){return(m=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function h(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))}function _(e,t){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var g,y=o.resolve(process.cwd(),"./.ppmvi.js");n.existsSync(y)&&(g=require(y).default.favicons||{});if(g&&g.master_picture&&"inline"===g.master_picture.type){var b=o.resolve(process.cwd(),g.master_picture.content);n.existsSync(b)&&(g.master_picture.content=n.readFileSync(b).toString("base64"))}var v=m(m({},{api_key:"",master_picture:{type:"url",url:""},files_location:{type:"path",path:"/static/icons"},favicon_design:{desktop_browser:{},ios:{picture_aspect:"background_and_margin",margin:"8",background_color:"#FFFFFF",assets:{ios6_and_prior_icons:!1,ios7_and_later_icons:!1,precomposed_icons:!1,declare_only_default_icon:!0}},windows:{picture_aspect:"white_silhouette",background_color:"#FFFFFF",assets:{windows_80_ie_10_tile:!0,windows_10_ie_11_edge_tiles:{small:!1,medium:!0,big:!1,rectangle:!1}}},android_chrome:{picture_aspect:"background_and_margin",margin:"12",background_color:"#FFFFFF",theme_color:"#FFFFFF",manifest:{name:"My sample app",display:"standalone",orientation:"portrait",start_url:"/"},assets:{legacy_icon:!1,low_resolution_icons:!1}},safari_pinned_tab:{picture_aspect:"black_and_white",threshold:60,theme_color:"#FFFFFF"}},settings:{compression:"5",scaling_algorithm:"Mitchell",error_on_image_too_small:!0,readme_file:!1,html_code_file:!1,use_path_as_is:!0}}),g);var F=function(){function e(){}return Object.defineProperty(e,"EXIF_USER_COMMENT",{get:function(){return"Compressed with TinyPNG by @ppmvi/needful-things"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PNG_TEXT_CHUNKG_FLAG",{get:function(){return"tEXt"},enumerable:!0,configurable:!0}),e.prototype.readUserComment=function(e){var t="",r=o.extname(e),s=n.readFileSync(e).toString("binary");if(".png"===r){var i=l.splitChunk(s),a=this.getUserCommentFromPngChunks(i);t=a?a.data:""}else{var c=".png"!==r?p.load(s).Exif:void 0;t=void 0!==c&&c[p.TagValues.ExifIFD.UserComment]?c[p.TagValues.ExifIFD.UserComment]:""}return t},e.prototype.addUserComment=function(t,r){var n,s=t;if(".png"===o.extname(r)){var i=l.splitChunk(t);if(!this.getUserCommentFromPngChunks(i)){var a=i.pop(),c=l.createChunk(e.PNG_TEXT_CHUNKG_FLAG,e.EXIF_USER_COMMENT);i.push(c),i.push(a),s=l.joinChunk(i)}}else{var u={Exif:(n={},n[p.TagValues.ExifIFD.UserComment]=e.EXIF_USER_COMMENT,n)},f=p.dump(u);s=p.insert(f,t)}return Buffer.from(s,"binary")},e.prototype.getUserCommentFromPngChunks=function(t){for(var r,n=0,o=t;n<o.length;n++){var s=o[n];if(s.type===e.PNG_TEXT_CHUNKG_FLAG){r=s;break}}return r},e}(),w=function(e){function t(){var t=e.call(this)||this;return t.config={},t.getConfig(),t}return function(e,t){function r(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.run=function(){return h(this,void 0,void 0,(function(){var e,t,r,n,o,s;return _(this,(function(i){switch(i.label){case 0:return i.trys.push([0,9,,10]),[4,this.setCompressionCount()];case 1:return i.sent(),[4,this.getFiles()];case 2:return e=i.sent(),e.filter((function(e){return!(e instanceof f.Separator||e.disabled)})).length>0?[4,f.prompt([{type:"checkbox",message:"Select the files which should be compressed.",name:"selectedFiles",pageSize:e.length,choices:e,validate:function(e){return!(e.length<1)||"You must at least choose one image."}}])]:[3,7];case 3:return t=i.sent().selectedFiles,[4,f.prompt([{type:"confirm",message:"You are about to compress the selected images. Do you want to continue?",name:"compress",default:!0},{type:"confirm",message:"Do you want to add a compressed flag to the file name? eg. test_compressed.png",name:"addCompressFlag",default:!1,when:function(e){return e.compress}}])];case 4:return r=i.sent(),n=r.compress,o=r.addCompressFlag,n?[4,this.doCompression(t,o)]:[3,6];case 5:i.sent(),i.label=6;case 6:return[3,8];case 7:console.log(c.info,u.bold("You already compressed all images.")),i.label=8;case 8:return[3,10];case 9:return s=i.sent(),console.log(s),console.log(c.error,u.bold("Looks like your key is not valid.")),[3,10];case 10:return[2]}}))}))},t.prototype.doCompression=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=!1),h(this,void 0,void 0,(function(){var r,a,c,u,l;return _(this,(function(p){switch(p.label){case 0:r=function(e){var r,c,u,l,p,f,d,m,h;return _(this,(function(_){switch(_.label){case 0:r=process.cwd()+e,c=o.dirname(r),u=o.extname(r),l=o.basename(r).replace(u,""),p=t?"_compressed":"",f=n.readFileSync(r),d=s("Compressing "+l+u).start(),m=void 0,_.label=1;case 1:return _.trys.push([1,3,,4]),[4,new Promise((function(e,t){i.fromBuffer(f).toBuffer((function(r,n){r&&t(r),e(n)}))}))];case 2:return m=_.sent(),[3,4];case 3:return h=_.sent(),d.fail(h.message),[2,"break"];case 4:return n.writeFileSync(c+"/"+l+p+u,a.addUserComment(m.toString(),r)),d.succeed(),[2]}}))},a=this,c=0,u=e,p.label=1;case 1:return c<u.length?(l=u[c],[5,r(l)]):[3,4];case 2:if("break"===p.sent())return[3,4];p.label=3;case 3:return c++,[3,1];case 4:return[2]}}))}))},t.prototype.getFiles=function(){return h(this,void 0,void 0,(function(){var e,t,n=this;return _(this,(function(s){switch(s.label){case 0:return[4,r(a)(process.cwd()+"/src/**/*.{png,jpg,jpeg}",{})];case 1:return e=s.sent(),t="",[2,e.reduce((function(e,r,s){var i=r.replace(process.cwd(),"");return t?t&&t!==o.dirname(i)&&(e.push(new f.Separator("----------")),t=o.dirname(i)):t=o.dirname(i),e.push({name:i,checked:!0,disabled:!(!i.match(/compressed/)&&!n.readUserComment(r).includes(F.EXIF_USER_COMMENT))&&"Already compressed"}),e}),[])]}}))}))},t.prototype.setCompressionCount=function(){return h(this,void 0,void 0,(function(){return _(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,new Promise((function(e,t){i.validate((function(r){r&&t(r),e()}))}))];case 1:return e.sent(),this.compressionsThisMonth=i.compressionCount,void 0===this.compressionsThisMonth?console.log(c.info,u.bold("Couldnt get the compressions count. You probably havent done any compressions.")):console.log(c.info,u.bold("You already used "+this.compressionsThisMonth+"/500 free compressions this month.")),[3,3];case 2:throw e.sent();case 3:return[2]}}))}))},t.prototype.getConfig=function(){var e=o.resolve(process.cwd(),"./.ppmvi.js"),t={};n.existsSync(e)&&(t=require(e).default),this.config=m(m({},{tinify:{key:""}}),t)},t}(F);exports.generateFavicons=function(e){return void 0===e&&(e="./static/icons"),h(this,void 0,void 0,(function(){var n,o,i;return _(this,(function(a){switch(a.label){case 0:n=s("Generating Favicons").start(),o=t.init(),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r(o.generateFavicon)(v,e)];case 2:return a.sent(),n.succeed(),[3,4];case 3:return i=a.sent(),n.fail(i.message),[3,4];case 4:return[2]}}))}))},exports.tinify=function(){return h(this,void 0,void 0,(function(){return _(this,(function(e){switch(e.label){case 0:return[4,(new w).run()];case 1:return e.sent(),[2]}}))}))};
//# sourceMappingURL=index.min.js.map
