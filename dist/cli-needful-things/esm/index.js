/*!
 * Needful things vnull
 * Copyright 2020 Florian Weber - ppm visuals & internet GmbH
 * Released under the MIT License.
*/
import e from"rfg-api";import t from"pify";import n from"fs";import r from"path";import o from"ora";import s from"tinify";import i from"glob";import a from"log-symbols";import c from"chalk";import u from"png-metadata";import{load as l,TagValues as p,dump as f,insert as m}from"piexifjs";import{prompt as d,Separator as h}from"inquirer";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var _=function(e,t){return(_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};var g=function(){return(g=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function y(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))}function v(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var b,F=r.resolve(process.cwd(),"./.ppmvi.js");n.existsSync(F)&&(b=require(F).default.favicons||{});if(b&&b.master_picture&&"inline"===b.master_picture.type){var w=r.resolve(process.cwd(),b.master_picture.content);n.existsSync(w)&&(b.master_picture.content=n.readFileSync(w).toString("base64"))}var C=g(g({},{api_key:"",master_picture:{type:"url",url:""},files_location:{type:"path",path:"/static/icons"},favicon_design:{desktop_browser:{},ios:{picture_aspect:"background_and_margin",margin:"8",background_color:"#FFFFFF",assets:{ios6_and_prior_icons:!1,ios7_and_later_icons:!1,precomposed_icons:!1,declare_only_default_icon:!0}},windows:{picture_aspect:"white_silhouette",background_color:"#FFFFFF",assets:{windows_80_ie_10_tile:!0,windows_10_ie_11_edge_tiles:{small:!1,medium:!0,big:!1,rectangle:!1}}},android_chrome:{picture_aspect:"background_and_margin",margin:"12",background_color:"#FFFFFF",theme_color:"#FFFFFF",manifest:{name:"My sample app",display:"standalone",orientation:"portrait",start_url:"/"},assets:{legacy_icon:!1,low_resolution_icons:!1}},safari_pinned_tab:{picture_aspect:"black_and_white",threshold:60,theme_color:"#FFFFFF"}},settings:{compression:"5",scaling_algorithm:"Mitchell",error_on_image_too_small:!0,readme_file:!1,html_code_file:!1,use_path_as_is:!0}}),b);function k(n){return void 0===n&&(n="./static/icons"),y(this,void 0,void 0,(function(){var r,s,i;return v(this,(function(a){switch(a.label){case 0:r=o("Generating Favicons").start(),s=e.init(),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,t(s.generateFavicon)(C,n)];case 2:return a.sent(),r.succeed(),[3,4];case 3:return i=a.sent(),r.fail(i.message),[3,4];case 4:return[2]}}))}))}var E=function(){function e(){}return Object.defineProperty(e,"EXIF_USER_COMMENT",{get:function(){return"Compressed with TinyPNG by @ppmvi/needful-things"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PNG_TEXT_CHUNKG_FLAG",{get:function(){return"tEXt"},enumerable:!0,configurable:!0}),e.prototype.readUserComment=function(e){var t="",o=r.extname(e),s=n.readFileSync(e).toString("binary");if(".png"===o){var i=u.splitChunk(s),a=this.getUserCommentFromPngChunks(i);t=a?a.data:""}else{var c=".png"!==o?l(s).Exif:void 0;t=void 0!==c&&c[p.ExifIFD.UserComment]?c[p.ExifIFD.UserComment]:""}return t},e.prototype.addUserComment=function(t,n){var o,s=t;if(".png"===r.extname(n)){var i=u.splitChunk(t);if(!this.getUserCommentFromPngChunks(i)){var a=i.pop(),c=u.createChunk(e.PNG_TEXT_CHUNKG_FLAG,e.EXIF_USER_COMMENT);i.push(c),i.push(a),s=u.joinChunk(i)}}else{var l={Exif:(o={},o[p.ExifIFD.UserComment]=e.EXIF_USER_COMMENT,o)},d=f(l);s=m(d,t)}return Buffer.from(s,"binary")},e.prototype.getUserCommentFromPngChunks=function(t){for(var n,r=0,o=t;r<o.length;r++){var s=o[r];if(s.type===e.PNG_TEXT_CHUNKG_FLAG){n=s;break}}return n},e}(),x=function(e){function u(){var t=e.call(this)||this;return t.config={},t.getConfig(),t}return function(e,t){function n(){this.constructor=e}_(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(u,e),u.prototype.run=function(){return y(this,void 0,void 0,(function(){var e,t,n,r,o,s;return v(this,(function(i){switch(i.label){case 0:return i.trys.push([0,9,,10]),[4,this.setCompressionCount()];case 1:return i.sent(),[4,this.getFiles()];case 2:return e=i.sent(),e.filter((function(e){return!(e instanceof h||e.disabled)})).length>0?[4,d([{type:"checkbox",message:"Select the files which should be compressed.",name:"selectedFiles",pageSize:e.length,choices:e,validate:function(e){return!(e.length<1)||"You must at least choose one image."}}])]:[3,7];case 3:return t=i.sent().selectedFiles,[4,d([{type:"confirm",message:"You are about to compress the selected images. Do you want to continue?",name:"compress",default:!0},{type:"confirm",message:"Do you want to add a compressed flag to the file name? eg. test_compressed.png",name:"addCompressFlag",default:!1,when:function(e){return e.compress}}])];case 4:return n=i.sent(),r=n.compress,o=n.addCompressFlag,r?[4,this.doCompression(t,o)]:[3,6];case 5:i.sent(),i.label=6;case 6:return[3,8];case 7:console.log(a.info,c.bold("You already compressed all images.")),i.label=8;case 8:return[3,10];case 9:return s=i.sent(),console.log(s),console.log(a.error,c.bold("Looks like your key is not valid.")),[3,10];case 10:return[2]}}))}))},u.prototype.doCompression=function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=!1),y(this,void 0,void 0,(function(){var i,a,c,u,l;return v(this,(function(p){switch(p.label){case 0:i=function(e){var i,c,u,l,p,f,m,d,h;return v(this,(function(_){switch(_.label){case 0:i=process.cwd()+e,c=r.dirname(i),u=r.extname(i),l=r.basename(i).replace(u,""),p=t?"_compressed":"",f=n.readFileSync(i),m=o("Compressing "+l+u).start(),d=void 0,_.label=1;case 1:return _.trys.push([1,3,,4]),[4,new Promise((function(e,t){s.fromBuffer(f).toBuffer((function(n,r){n&&t(n),e(r)}))}))];case 2:return d=_.sent(),[3,4];case 3:return h=_.sent(),m.fail(h.message),[2,"break"];case 4:return n.writeFileSync(c+"/"+l+p+u,a.addUserComment(d.toString(),i)),m.succeed(),[2]}}))},a=this,c=0,u=e,p.label=1;case 1:return c<u.length?(l=u[c],[5,i(l)]):[3,4];case 2:if("break"===p.sent())return[3,4];p.label=3;case 3:return c++,[3,1];case 4:return[2]}}))}))},u.prototype.getFiles=function(){return y(this,void 0,void 0,(function(){var e,n,o=this;return v(this,(function(s){switch(s.label){case 0:return[4,t(i)(process.cwd()+"/src/**/*.{png,jpg,jpeg}",{})];case 1:return e=s.sent(),n="",[2,e.reduce((function(e,t,s){var i=t.replace(process.cwd(),"");return n?n&&n!==r.dirname(i)&&(e.push(new h("----------")),n=r.dirname(i)):n=r.dirname(i),e.push({name:i,checked:!0,disabled:!(!i.match(/compressed/)&&!o.readUserComment(t).includes(E.EXIF_USER_COMMENT))&&"Already compressed"}),e}),[])]}}))}))},u.prototype.setCompressionCount=function(){return y(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,new Promise((function(e,t){s.validate((function(n){n&&t(n),e()}))}))];case 1:return e.sent(),this.compressionsThisMonth=s.compressionCount,void 0===this.compressionsThisMonth?console.log(a.info,c.bold("Couldnt get the compressions count. You probably havent done any compressions.")):console.log(a.info,c.bold("You already used "+this.compressionsThisMonth+"/500 free compressions this month.")),[3,3];case 2:throw e.sent();case 3:return[2]}}))}))},u.prototype.getConfig=function(){var e=r.resolve(process.cwd(),"./.ppmvi.js"),t={};n.existsSync(e)&&(t=require(e).default),this.config=g(g({},{tinify:{key:""}}),t)},u}(E);function S(){return y(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,(new x).run()];case 1:return e.sent(),[2]}}))}))}export{k as generateFavicons,S as tinify};
//# sourceMappingURL=index.js.map
